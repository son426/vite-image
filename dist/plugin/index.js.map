{"version":3,"sources":["../../src/plugin/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["// src/plugin/index.ts\n\nimport type { PluginOption } from \"vite\";\nimport { imagetools } from \"vite-imagetools\";\nimport { createFilter } from \"@rollup/pluginutils\";\nimport type { ViteImageConfig, AutoApplyConfig } from \"../types\";\n\nexport type ViteImagePluginOptions = Parameters<typeof imagetools>[0];\n\n// Re-export types for convenience\nexport type { ViteImageConfig, AutoApplyConfig } from \"../types\";\n\n// Default configuration\nconst DEFAULT_BREAKPOINTS = [640, 1024, 1920];\n\n// Utility functions\nfunction getFileExtension(id: string): string | null {\n  // 쿼리 파라미터 제거\n  const [basePath] = id.split(\"?\");\n\n  // 확장자 추출\n  const match = basePath.match(/\\.([^.]+)$/);\n  return match ? `.${match[1]}` : null;\n}\n\nfunction matchesExtension(id: string, extensions: string[]): boolean {\n  if (!extensions || extensions.length === 0) return false;\n\n  const ext = getFileExtension(id);\n  if (!ext) return false;\n\n  return extensions.includes(ext);\n}\n\nfunction generateSrcSetParams(breakpoints: number[], quality?: number): string {\n  const qualityParam = quality ? `&quality=${quality}` : '';\n  return `w=${breakpoints.join(\";\")}&format=webp${qualityParam}&as=srcset`;\n}\n\nfunction generateMetaParams(breakpoints: number[], quality?: number): string {\n  const maxWidth = Math.max(...breakpoints);\n  const qualityParam = quality ? `&quality=${quality}` : '';\n  return `w=${maxWidth}&format=webp${qualityParam}&as=meta`;\n}\n\nfunction generateImageCode(basePath: string, breakpoints: number[], quality?: number): string {\n  const srcSetParams = generateSrcSetParams(breakpoints, quality);\n  const metaParams = generateMetaParams(breakpoints, quality);\n  const blurQuality = quality ?? 20;\n  const lqipParams = `w=20&blur=2&quality=${blurQuality}&format=webp&inline`;\n\n  // meta를 먼저 import하고, 그 다음에 srcSet과 blurDataURL을 import\n  // 이렇게 하면 초기화 순서 문제를 방지할 수 있음\n  return `\n    import meta from \"${basePath}?${metaParams}\";\n    import srcSet from \"${basePath}?${srcSetParams}\";\n    import blurDataURL from \"${basePath}?${lqipParams}\";\n    \n    export default {\n      src: meta.src,\n      width: meta.width,\n      height: meta.height,\n      srcSet: srcSet,\n      blurDataURL: blurDataURL\n    };\n  `;\n}\n\nfunction shouldAutoApply(\n  id: string,\n  autoApply: AutoApplyConfig | undefined,\n  filter: ((id: string) => boolean) | null\n): boolean {\n  // autoApply 설정이 없으면 false\n  if (!autoApply) return false;\n\n  // extensions가 없거나 빈 배열이면 false\n  if (!autoApply.extensions || autoApply.extensions.length === 0) {\n    return false;\n  }\n\n  // 확장자 매칭\n  if (!matchesExtension(id, autoApply.extensions)) {\n    return false;\n  }\n\n  // glob 패턴 매칭 (include/exclude)\n  if (filter && !filter(id)) {\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Vite plugin for image optimization using vite-imagetools\n * This plugin handles ?vite-image queries and uses imagetools for image processing\n *\n * @param config - Configuration options for vite-image plugin\n * @returns Array of Vite plugins (vite-image macro and imagetools)\n *\n * @example\n * ```ts\n * // vite.config.ts\n * import { defineConfig } from 'vite';\n * import { viteImage } from '@son426/vite-image/plugin';\n *\n * export default defineConfig({\n *   plugins: [\n *     ...viteImage({\n *       breakpoints: [640, 1024, 1920],\n *       autoApply: {\n *         extensions: ['.jpg', '.png'],\n *         include: ['src/**'],\n *         exclude: ['src/icons/**']\n *       }\n *     }),\n *   ],\n * });\n * ```\n */\nexport function viteImage(config?: ViteImageConfig): PluginOption[] {\n  // Config 병합\n  const breakpoints = config?.breakpoints ?? DEFAULT_BREAKPOINTS;\n  const autoApply = config?.autoApply;\n  const imagetoolsOptions = config?.imagetools;\n\n  // Glob 필터 생성 (autoApply가 있을 때만)\n  const filter = autoApply\n    ? createFilter(autoApply.include, autoApply.exclude)\n    : null;\n\n  // 커스텀 플러그인: ?vite-image 쿼리를 처리\n  const viteImageMacro: PluginOption = {\n    name: \"vite-plugin-vite-image-macro\",\n    enforce: \"pre\" as const,\n    async load(id: string) {\n      const [basePath, search] = id.split(\"?\");\n      const params = new URLSearchParams(search);\n\n      // 1. 명시적 쿼리 체크 (기존 로직)\n      if (params.has(\"vite-image\")) {\n        const quality = params.get(\"quality\") ? parseInt(params.get(\"quality\")!, 10) : undefined;\n        return generateImageCode(basePath, breakpoints, quality);\n      }\n\n      // 2. autoApply 체크\n      if (shouldAutoApply(id, autoApply, filter)) {\n        // ?vite-image 쿼리를 자동으로 추가하여 처리\n        return generateImageCode(basePath, breakpoints);\n      }\n\n      return null;\n    },\n  };\n\n  return [viteImageMacro, imagetools(imagetoolsOptions)];\n}\n"]}